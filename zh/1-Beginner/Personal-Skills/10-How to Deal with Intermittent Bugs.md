# 如何處理偶現的 Bugs
[//]: # (Version:1.0.0)
偶現 bug 是一種類似於外太空50足隱身蠍子的東西。這種噩夢是如此稀少以至於它很難觀察，但其出現頻率使得它不能被忽視。你不能偵錯因為你不能找到它。

儘管在8個小時後你會開始懷疑，偶現的 bug 必須像其他事情一樣遵循相同的邏輯規律。但困難的是它只發生在一些未知的情形。嘗試著去記錄這個 bug 出現時的情景，這樣你可以去推測到底是什麼樣的可變性。情況可能跟資料的值相關，比如“這只是在我們把*Wyoming*作為一個值輸入時發生”，如果這不是可變性的根源，下一個懷疑應該是不合適的同步併發。

嘗試，嘗試，嘗試去在一種可控的方式下重現這個 bug。如果你不能重現它，用日誌系統給它設定一個圈套，來在你需要的時候，在它真的發生的時候，記錄你猜想的，需要的東西。重新設計這個圈套，如果這個bug只發生在產品中，且不在你的猜想中的話，這可能是一個漫長的過程。你從日誌中得到的（資訊）可能不能提供解決方案，但可能給你足夠的資訊去優化這個日誌。優化後的日誌系統可能花很長時間才能被放入產品中使用。然後，你必須等待 bug 重新出現以獲得更多的資訊。這個迴圈可能會繼續好幾次。

我曾建立過的最愚蠢的偶現 bug 是在用一個函數語言程式設計語言裡為類工程做多執行緒實現的時候。我非常仔細地保證了函數式程式的併發估計， CPU 的充分使用（在這個例子裡，是8個 CPU）。我卻簡單地忘記了去同步垃圾回收器。系統可能執行了很長一段時間，經常結束在我開始任何一個任務的時候，在任何能被注意到的事情出錯之前。我很遺憾地承認在我理解我的錯誤之前，我甚至開始懷疑硬體了。

在工作中我們最近有這樣一個偶現的 bug 讓我們花了幾個星期才發現。我們有一個多執行緒的基於 Apache™ 的 Java™web 伺服器,在維護第一個頁面跳轉的時候，我們在四個獨立執行緒而非頁面跳轉執行緒裡，為一個小的集合執行所有的 I/O 操作。每一次跳轉會產生明顯的卡頓然後停止做任何有用的事情，直到幾個小時後，我們的日誌才讓我們瞭解到底發生了什麼。因為我們有四個執行緒，在一個執行緒內部發生這種情況並不是什麼大問題，除非所有的四個執行緒都阻塞了。然後被這些執行緒排空的佇列會迅速填充所有可用的記憶體，然後導致我們的伺服器崩潰。這個 bug 花了我們一個星期去揪出這個問題，但我們仍然不知道什麼導致了這個現象，不知道它什麼時候會發生，甚至不知道它們阻塞的時候，執行緒們在幹什麼。

這表明了有關使用第三方軟體的一些風險。我們在使用一段授權的程式碼，從文字中移除HTML標籤。受它的起源的影響，我們把它叫做法國脫衣舞者。儘管我們有原始碼（由衷感謝！），我們沒有仔細研究它，直到檢視我們伺服器的日誌的時候，我們最終意識到是“法國脫衣舞者”使郵件執行緒阻塞了。

這個工具在大多數時候工作得很好，除了處理一些長而不常見的文字時。在那些文字里，程式碼複雜度是 N 的平方或者更糟。這意味著處理時間與文字的長度的平方成正比。正式由於這些文字通常都會出現，所以我們才可以馬上發現這個 bug。如果他們從來都不會出現，我們永遠都不會發現這個問題。當它發生時，我們花了幾個星期去最終理解並且解決了這個問題。

Next [如何學習設計技能](11-How to Learn Design Skills.md)
